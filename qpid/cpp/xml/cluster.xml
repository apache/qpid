o<?xml version="1.0"?>
<!--
-
- Licensed to the Apache Software Foundation (ASF) under one
- or more contributor license agreements.  See the NOTICE file
- distributed with this work for additional information
- regarding copyright ownership.  The ASF licenses this file
- to you under the Apache License, Version 2.0 (the
- "License"); you may not use this file except in compliance
- with the License.  You may obtain a copy of the License at
- 
-   http://www.apache.org/licenses/LICENSE-2.0
- 
- Unless required by applicable law or agreed to in writing,
- software distributed under the License is distributed on an
- "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
- KIND, either express or implied.  See the License for the
- specific language governing permissions and limitations
- under the License.
-
-->

<amqp major="0" minor="10" port="5672">

  <!-- Controls sent between cluster nodes. -->

  <class name = "cluster" code = "0x80" label="Qpid clustering extensions.">
    <doc>Qpid extension class to allow clustered brokers to communicate.</doc>

    <!-- Cluster membership -->

    <control name = "dump-request" code="0x1" label="Url to use for a cluster member">
      <field name="url" type="str16" label="URL for brain dump to new member."/>
    </control>

    <control name = "dump-error" code="0x2" label="Error while dumping to new member">
      <field name="dumpee" type="uint64"/>
    </control>

    <control name = "ready" code="0x3" label="Cluster member ready at URL">
      <field name="url" type="str16" label="URL for client connections."/>
    </control>

    <control name="map" code="0x4" label="Cluster map sent to new members.">
      <field name="members" type="map"/>     <!-- member-id -> URL -->
      <field name="dumpees" type="map"/> <!-- dumpee-id -> braindump URL -->
      <field name="dumps" type="map"/>	<!-- dumpee-id -> donor-id -->
    </control>

    <!-- Transferring broker state -->

  </class>

  <!-- TODO aconway 2008-09-10: support for un-attached connections. -->
  
  <!-- Controls associated with a specific connection. -->

  <class name="cluster-connection" code="0x81" label="Qpid clustering extensions.">

    <control name="deliver-close" code="0x2">
    </control>

    <control name="deliver-do-output" code="0x3">
      <field name="bytes" type="uint32"/>
    </control>

    <!-- Brain-dump controls. Sent to a new broker in joining mode.
	 A connection is dumped as followed:
	 - open as a normal connection.
	 - attach sessions, create consumers, set flow with normal AMQP cokmmands.
	 - reset session state by sending session-state for each session.
	  - frames following session-state are replay frames.
	 - send shadow-ready to mark end of dump.
    -->
    <control name="session-state" code="0x4" label="Set session state during a brain dump.">
      <!-- Target session deduced from channel number.  -->

      <field name="replay-start" type="sequence-no"/>	       <!-- Replay frames will start from this point.-->
      <field name="sent-incomplete" type="sequence-set"/>      <!-- Commands sent and incomplete. -->

      <field name="expected" type="sequence-no"/>	       <!-- Idempotence barrier -->
      <field name="received" type="sequence-no"/>	       <!-- Received up to here > expected-->
      <field name="unknown-completed" type="sequence-set"/>    <!-- Completed but not known to peer. -->
      <field name="received-incomplete" type="sequence-set"/>  <!-- Received and incomplete -->
    </control>

    <control name="shadow-ready" code="0x5" label="End of shadow connection dump.">
      <field name="member-id" type="uint64"/>
      <field name="connection-id" type="uint64"/>
    </control>

  </class>
</amqp>
